<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calorie Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000000;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .sync-indicator {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .sync-indicator.syncing {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.4; }
        }

        .goal {
            font-size: 14px;
            opacity: 0.9;
        }

        .progress-section {
            padding: 20px;
            background: #f8f9fa;
        }

        .progress-bar-container {
            background: #e0e0e0;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #45a049 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .progress-bar.over {
            background: linear-gradient(90deg, #f44336 0%, #d32f2f 100%);
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .input-section {
            padding: 20px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .voice-btn {
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            min-width: 50px;
        }

        .voice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .voice-btn:active {
            transform: translateY(0);
        }

        .voice-btn.listening {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            animation: pulse-voice 1.5s ease-in-out infinite;
        }

        @keyframes pulse-voice {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        input[type="number"] {
            flex: 0.6;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .entries-section {
            padding: 20px;
        }

        .view-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 10px;
        }

        .view-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            color: #666;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .view-btn:hover {
            transform: none;
            box-shadow: none;
            background: rgba(102, 126, 234, 0.1);
        }

        .view-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .day-group {
            margin-bottom: 30px;
        }

        .day-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .day-total {
            font-size: 16px;
        }

        .summary-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .summary-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .summary-stat {
            background: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .summary-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .summary-stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }

        .date-header {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: background 0.2s;
        }

        .entry:hover {
            background: #e9ecef;
        }

        .entry-info {
            flex: 1;
        }

        .entry-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .entry-time {
            font-size: 12px;
            color: #999;
        }

        .entry-calories {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-right: 15px;
        }

        .delete-btn {
            padding: 8px 12px;
            background: #f44336;
            font-size: 14px;
            min-width: auto;
        }

        .delete-btn:hover {
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .reset-btn {
            width: 100%;
            margin-top: 10px;
            background: #f44336;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 24px;
            }

            .stats {
                gap: 10px;
            }

            .stat-value {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçé Calorie Tracker</h1>
            <div class="goal">Daily Goal: 2100 calories</div>
            <div class="sync-indicator" id="syncIndicator">‚òÅÔ∏è Synced across devices</div>
        </div>

        <div class="progress-section">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar">0 / 2100</div>
            </div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="totalCalories">0</div>
                    <div class="stat-label">Consumed</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="remaining">2100</div>
                    <div class="stat-label">Remaining</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="percentage">0%</div>
                    <div class="stat-label">of Goal</div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="input-group">
                <input type="text" id="foodName" placeholder="What did you eat? (e.g., 2 eggs and toast, medium banana, slice of pizza)" autocomplete="off">
                <button class="voice-btn" onclick="startVoiceInput()" id="voiceBtn" title="Voice input">
                    üé§
                </button>
            </div>
            <button onclick="addEntry()" id="addBtn">Add Entry</button>
            <button class="reset-btn" onclick="resetDay()">Reset Today</button>
        </div>

        <div class="entries-section">
            <div class="view-selector">
                <button class="view-btn active" onclick="changeView('day')">Today</button>
                <button class="view-btn" onclick="changeView('week')">Week</button>
                <button class="view-btn" onclick="changeView('month')">Month</button>
            </div>
            <div class="date-header" id="dateHeader"></div>
            <div id="entriesList"></div>
        </div>
    </div>

    <script>
        const DAILY_GOAL = 2100;
        const STORAGE_KEY = 'calorie-tracker-data';
        let currentView = 'day';
        let cachedData = null;
        let lastSyncTime = 0;

        async function loadData() {
            // Check if we have recent cached data (less than 5 seconds old)
            const now = Date.now();
            if (cachedData && (now - lastSyncTime) < 5000) {
                return cachedData;
            }

            try {
                const result = await window.storage.get(STORAGE_KEY, true);
                const data = result ? JSON.parse(result.value) : {};
                cachedData = data;
                lastSyncTime = now;
                return data;
            } catch (error) {
                console.error('Error loading data:', error);
                // Fallback to empty data if key doesn't exist yet
                return {};
            }
        }

        async function saveData(data) {
            const syncIndicator = document.getElementById('syncIndicator');
            if (syncIndicator) {
                syncIndicator.textContent = '‚òÅÔ∏è Syncing...';
                syncIndicator.classList.add('syncing');
            }

            try {
                await window.storage.set(STORAGE_KEY, JSON.stringify(data), true);
                cachedData = data;
                lastSyncTime = Date.now();
                
                if (syncIndicator) {
                    syncIndicator.textContent = '‚òÅÔ∏è Synced across devices';
                    syncIndicator.classList.remove('syncing');
                }
            } catch (error) {
                console.error('Error saving data:', error);
                if (syncIndicator) {
                    syncIndicator.textContent = '‚ö†Ô∏è Sync error';
                    syncIndicator.classList.remove('syncing');
                }
                alert('Error saving data. Please try again.');
            }
        }

        async function getTodayEntries() {
            const data = await loadData();
            const todayKey = getTodayKey();
            return data[todayKey] || [];
        }

        function getTodayKey() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        function getDateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function getWeekDates() {
            const dates = [];
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push(getDateKey(date));
            }
            return dates;
        }

        function getMonthDates() {
            const dates = [];
            const today = new Date();
            const daysInMonth = 30;
            for (let i = daysInMonth - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push(getDateKey(date));
            }
            return dates;
        }

        function formatDate(dateKey) {
            const [year, month, day] = dateKey.split('-');
            const date = new Date(year, month - 1, day);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function formatDateShort(dateKey) {
            const [year, month, day] = dateKey.split('-');
            const date = new Date(year, month - 1, day);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (getDateKey(date) === getDateKey(today)) {
                return 'Today';
            } else if (getDateKey(date) === getDateKey(yesterday)) {
                return 'Yesterday';
            } else {
                const options = { weekday: 'short', month: 'short', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            }
        }

        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : {};
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function getTodayEntries() {
            const data = loadData();
            const todayKey = getTodayKey();
            return data[todayKey] || [];
        }

        async function addEntry() {
            const foodName = document.getElementById('foodName').value.trim();

            if (!foodName) {
                alert('Please enter what you ate');
                return;
            }

            // Disable button and show loading state
            const addBtn = document.getElementById('addBtn');
            const originalText = addBtn.textContent;
            addBtn.disabled = true;
            addBtn.textContent = 'Estimating calories...';

            try {
                // Get calorie estimate from AI
                const calories = await estimateCalories(foodName);

                const data = await loadData();
                const todayKey = getTodayKey();

                if (!data[todayKey]) {
                    data[todayKey] = [];
                }

                const entry = {
                    id: Date.now(),
                    name: foodName,
                    calories: calories,
                    time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                };

                data[todayKey].push(entry);
                await saveData(data);

                document.getElementById('foodName').value = '';
                document.getElementById('foodName').focus();

                await render();
            } catch (error) {
                console.error('Error estimating calories:', error);
                alert('Error estimating calories. Please check your internet connection and try again. If the problem persists, try being more specific (e.g., "1 cup of corn flakes").');
            } finally {
                addBtn.disabled = false;
                addBtn.textContent = originalText;
            }
        }

        async function estimateCalories(foodDescription) {
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [
                            {
                                role: "user",
                                content: `Estimate the total calories for: "${foodDescription}". 
                                
If no portion size is specified, assume a typical/standard serving size.

Respond with ONLY a single number representing the estimated total calories. No explanation, no units, just the number.`
                            }
                        ],
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.content || !data.content[0] || !data.content[0].text) {
                    throw new Error('Invalid API response format');
                }
                
                const calorieText = data.content[0].text.trim();
                console.log('AI response:', calorieText);
                
                // Try to extract a number from the response
                const match = calorieText.match(/\d+/);
                if (!match) {
                    throw new Error('No number found in response');
                }
                
                const calories = parseInt(match[0]);
                
                if (isNaN(calories) || calories <= 0) {
                    throw new Error('Invalid calorie value');
                }
                
                return calories;
            } catch (error) {
                console.error('Calorie estimation error:', error);
                throw error;
            }
        }

        let recognition = null;
        let isListening = false;
        let autoAddTimeout = null;

        function startVoiceInput() {
            // Check if browser supports speech recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                alert('Voice input is not supported in your browser. Please use Chrome, Safari, or Edge.');
                return;
            }

            const voiceBtn = document.getElementById('voiceBtn');
            const foodInput = document.getElementById('foodName');

            // If already listening, stop
            if (isListening && recognition) {
                recognition.stop();
                return;
            }

            // Create new recognition instance
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = () => {
                isListening = true;
                voiceBtn.classList.add('listening');
                voiceBtn.textContent = 'üî¥';
                foodInput.placeholder = 'Listening...';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                foodInput.value = transcript;
                foodInput.focus();
                
                // Clear any existing timeout
                if (autoAddTimeout) {
                    clearTimeout(autoAddTimeout);
                }
                
                // Automatically add entry after 2 seconds
                autoAddTimeout = setTimeout(() => {
                    if (foodInput.value.trim()) {
                        addEntry();
                    }
                }, 2000);
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    alert('Microphone access denied. Please allow microphone access in your browser settings.');
                } else if (event.error === 'no-speech') {
                    alert('No speech detected. Please try again.');
                }
            };

            recognition.onend = () => {
                isListening = false;
                voiceBtn.classList.remove('listening');
                voiceBtn.textContent = 'üé§';
                foodInput.placeholder = 'What did you eat? (e.g., 2 eggs and toast, medium banana, slice of pizza)';
            };

            // Start recognition
            try {
                recognition.start();
            } catch (error) {
                console.error('Error starting recognition:', error);
                alert('Error starting voice input. Please try again.');
            }
        }

        function changeView(view) {
            currentView = view;
            
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            render();
        }

        async function deleteEntry(id) {
            const data = await loadData();
            const todayKey = getTodayKey();

            if (data[todayKey]) {
                data[todayKey] = data[todayKey].filter(entry => entry.id !== id);
                await saveData(data);
                await render();
            }
        }

        async function resetDay() {
            if (confirm('Are you sure you want to reset today\'s entries?')) {
                const data = await loadData();
                const todayKey = getTodayKey();
                delete data[todayKey];
                await saveData(data);
                await render();
            }
        }

        async function render() {
            const data = await loadData();
            
            if (currentView === 'day') {
                await renderDayView(data);
            } else if (currentView === 'week') {
                await renderWeekView(data);
            } else if (currentView === 'month') {
                await renderMonthView(data);
            }
        }

        async function renderDayView(data) {
            const entries = await getTodayEntries();
            const totalCalories = entries.reduce((sum, entry) => sum + entry.calories, 0);
            const remaining = DAILY_GOAL - totalCalories;
            const percentage = Math.round((totalCalories / DAILY_GOAL) * 100);
            const progressWidth = Math.min((totalCalories / DAILY_GOAL) * 100, 100);

            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = progressWidth + '%';
            progressBar.textContent = `${totalCalories} / ${DAILY_GOAL}`;
            progressBar.classList.toggle('over', totalCalories > DAILY_GOAL);

            // Update stats
            document.getElementById('totalCalories').textContent = totalCalories;
            document.getElementById('remaining').textContent = remaining;
            document.getElementById('remaining').style.color = remaining < 0 ? '#f44336' : '#667eea';
            document.getElementById('percentage').textContent = percentage + '%';

            // Update date header
            document.getElementById('dateHeader').textContent = formatDate(getTodayKey());

            // Update entries list
            const entriesList = document.getElementById('entriesList');
            if (entries.length === 0) {
                entriesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div>No entries yet today. Start tracking!</div>
                    </div>
                `;
            } else {
                entriesList.innerHTML = entries.reverse().map(entry => `
                    <div class="entry">
                        <div class="entry-info">
                            <div class="entry-name">${entry.name}</div>
                            <div class="entry-time">${entry.time}</div>
                        </div>
                        <div class="entry-calories">${entry.calories} cal</div>
                        <button class="delete-btn" onclick="deleteEntry(${entry.id})">Delete</button>
                    </div>
                `).join('');
            }
        }

        async function renderWeekView(data) {
            const weekDates = getWeekDates();
            let totalCalories = 0;
            let daysWithData = 0;
            let daysOverGoal = 0;

            // Calculate week summary
            weekDates.forEach(dateKey => {
                const dayEntries = data[dateKey] || [];
                const dayTotal = dayEntries.reduce((sum, entry) => sum + entry.calories, 0);
                if (dayEntries.length > 0) {
                    totalCalories += dayTotal;
                    daysWithData++;
                    if (dayTotal > DAILY_GOAL) daysOverGoal++;
                }
            });

            const avgCalories = daysWithData > 0 ? Math.round(totalCalories / daysWithData) : 0;
            const avgRemaining = DAILY_GOAL - avgCalories;

            // Update progress bar to show weekly average
            const progressBar = document.getElementById('progressBar');
            const progressWidth = Math.min((avgCalories / DAILY_GOAL) * 100, 100);
            progressBar.style.width = progressWidth + '%';
            progressBar.textContent = `${avgCalories} avg / ${DAILY_GOAL}`;
            progressBar.classList.toggle('over', avgCalories > DAILY_GOAL);

            // Update stats to show weekly averages
            document.getElementById('totalCalories').textContent = avgCalories;
            document.getElementById('remaining').textContent = avgRemaining;
            document.getElementById('remaining').style.color = avgRemaining < 0 ? '#f44336' : '#667eea';
            document.getElementById('percentage').textContent = Math.round((avgCalories / DAILY_GOAL) * 100) + '%';

            // Update header
            document.getElementById('dateHeader').textContent = 'Last 7 Days';

            // Render summary and day groups
            const entriesList = document.getElementById('entriesList');
            let html = `
                <div class="summary-section">
                    <div class="summary-title">Week Summary</div>
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <div class="summary-stat-value">${totalCalories.toLocaleString()}</div>
                            <div class="summary-stat-label">Total Calories</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value">${avgCalories}</div>
                            <div class="summary-stat-label">Daily Average</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value">${daysWithData}</div>
                            <div class="summary-stat-label">Days Tracked</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value">${daysOverGoal}</div>
                            <div class="summary-stat-label">Days Over Goal</div>
                        </div>
                    </div>
                </div>
            `;

            weekDates.reverse().forEach(dateKey => {
                const dayEntries = data[dateKey] || [];
                const dayTotal = dayEntries.reduce((sum, entry) => sum + entry.calories, 0);
                
                if (dayEntries.length > 0) {
                    html += `
                        <div class="day-group">
                            <div class="day-group-header">
                                <span>${formatDateShort(dateKey)}</span>
                                <span class="day-total">${dayTotal} cal</span>
                            </div>
                            ${dayEntries.reverse().map(entry => `
                                <div class="entry">
                                    <div class="entry-info">
                                        <div class="entry-name">${entry.name}</div>
                                        <div class="entry-time">${entry.time}</div>
                                    </div>
                                    <div class="entry-calories">${entry.calories} cal</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            });

            if (daysWithData === 0) {
                html += `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div>No entries this week</div>
                    </div>
                `;
            }

            entriesList.innerHTML = html;
        }

        async function renderMonthView(data) {
            const monthDates = getMonthDates();
            let totalCalories = 0;
            let daysWithData = 0;
            let daysOverGoal = 0;

            // Calculate month summary
            monthDates.forEach(dateKey => {
                const dayEntries = data[dateKey] || [];
                const dayTotal = dayEntries.reduce((sum, entry) => sum + entry.calories, 0);
                if (dayEntries.length > 0) {
                    totalCalories += dayTotal;
                    daysWithData++;
                    if (dayTotal > DAILY_GOAL) daysOverGoal++;
                }
            });

            const avgCalories = daysWithData > 0 ? Math.round(totalCalories / daysWithData) : 0;
            const avgRemaining = DAILY_GOAL - avgCalories;

            // Update progress bar to show monthly average
            const progressBar = document.getElementById('progressBar');
            const progressWidth = Math.min((avgCalories / DAILY_GOAL) * 100, 100);
            progressBar.style.width = progressWidth + '%';
            progressBar.textContent = `${avgCalories} avg / ${DAILY_GOAL}`;
            progressBar.classList.toggle('over', avgCalories > DAILY_GOAL);

            // Update stats to show monthly averages
            document.getElementById('totalCalories').textContent = avgCalories;
            document.getElementById('remaining').textContent = avgRemaining;
            document.getElementById('remaining').style.color = avgRemaining < 0 ? '#f44336' : '#667eea';
            document.getElementById('percentage').textContent = Math.round((avgCalories / DAILY_GOAL) * 100) + '%';

            // Update header
            document.getElementById('dateHeader').textContent = 'Last 30 Days';

            // Render summary and day groups
            const entriesList = document.getElementById('entriesList');
            let html = `
                <div class="summary-section">
                    <div class="summary-title">Month Summary</div>
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <div class="summary-stat-value">${totalCalories.toLocaleString()}</div>
                            <div class="summary-stat-label">Total Calories</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value">${avgCalories}</div>
                            <div class="summary-stat-label">Daily Average</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value">${daysWithData}</div>
                            <div class="summary-stat-label">Days Tracked</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value">${daysOverGoal}</div>
                            <div class="summary-stat-label">Days Over Goal</div>
                        </div>
                    </div>
                </div>
            `;

            monthDates.reverse().forEach(dateKey => {
                const dayEntries = data[dateKey] || [];
                const dayTotal = dayEntries.reduce((sum, entry) => sum + entry.calories, 0);
                
                if (dayEntries.length > 0) {
                    html += `
                        <div class="day-group">
                            <div class="day-group-header">
                                <span>${formatDateShort(dateKey)}</span>
                                <span class="day-total">${dayTotal} cal</span>
                            </div>
                            ${dayEntries.reverse().map(entry => `
                                <div class="entry">
                                    <div class="entry-info">
                                        <div class="entry-name">${entry.name}</div>
                                        <div class="entry-time">${entry.time}</div>
                                    </div>
                                    <div class="entry-calories">${entry.calories} cal</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            });

            if (daysWithData === 0) {
                html += `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div>No entries this month</div>
                    </div>
                `;
            }

            entriesList.innerHTML = html;
        }

        // Handle Enter key
        document.getElementById('foodName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addEntry();
            }
        });

        // Initial render
        render();
    </script>
</body>
</html>
